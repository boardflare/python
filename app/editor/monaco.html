<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Create Python Function</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs/loader.min.js"></script>
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
        body {
            margin: 10px;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 80px);
            gap: 10px;
        }

        #editor {
            border: 1px solid #ccc;
            height: 55%;
            width: 100%;
        }

        .block {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        #testEditor {
            border: 1px solid #ccc;
            height: 25%;
            width: 100%;
        }

        .button-row {
            margin: 10px 0;
            text-align: right;
        }

        .button-row button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- Add a dropdown for selecting functions -->
    <select id="functionDropdown">
        <!-- Options will be populated dynamically -->
    </select>
    <div class="editor-container">
        <div id="editor"></div>
        <div class="block">
            Write your Python function above. The function should take inputs and return a value.
            Test cases below should be a JSON array of objects containing input arguments and expected results.
        </div>
        <div id="testEditor"></div>
    </div>
    <div class="button-row">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn">Create Function</button>
    </div>

    <script>
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs' } });

        Office.onReady().then(() => {
            require(['vs/editor/editor.main'], function () {
                const defaultCode = [
                    'def foo(text):',
                    '    """ This is a sample function. """',
                    '    print(text)',
                    '    return text.capitalize()',
                ].join('\n');

                const defaultTestCases = [
                    '[',
                    '    {',
                    '        "arg1": "hello world",',
                    '        "result": "Hello world"',
                    '    },',
                    '    {',
                    '        "arg1": "testing",',
                    '        "result": "Testing"',
                    '    }',
                    ']'
                ].join('\n');

                const editor = monaco.editor.create(document.getElementById('editor'), {
                    value: defaultCode,
                    language: 'python',
                    theme: 'vs-dark',
                    fontSize: 16,
                    minimap: { enabled: false }
                });

                const testEditor = monaco.editor.create(document.getElementById('testEditor'), {
                    value: defaultTestCases,
                    language: 'json',
                    theme: 'vs-dark',
                    fontSize: 16,
                    minimap: { enabled: false }
                });

                // Request the list of functions from the parent page
                Office.context.ui.messageParent(JSON.stringify({ action: 'getFunctionsList' }));

                // Remove window event listener and use Office dialog messaging
                Office.context.ui.addHandlerAsync(
                    Microsoft.Office.WebExtension.EventType.DialogParentMessageReceived,
                    function (arg) {
                        console.log('Dialog received message:', arg);
                        try {
                            if (!arg.message) return;
                            const message = JSON.parse(arg.message);
                            console.log('Parsed message in dialog:', message);

                            if (message.type === 'functionsList') {
                                console.log('Populating dropdown with:', message.functions);
                                const dropdown = document.getElementById('functionDropdown');
                                dropdown.innerHTML = '<option value="">Select a function...</option>';

                                message.functions.forEach(func => {
                                    if (func && func.name) {
                                        const option = document.createElement('option');
                                        option.value = func.name;
                                        option.textContent = func.name;
                                        dropdown.appendChild(option);
                                    }
                                });
                            } else if (message.type === 'functionCode') {
                                console.log('Setting editor code to:', message.code);
                                editor.setValue(message.code || defaultCode);
                                testEditor.setValue(message.testCases || defaultTestCases);
                            }
                        } catch (error) {
                            console.error('Error in dialog message handler:', error);
                        }
                    }
                );

                document.getElementById('functionDropdown').onchange = function () {
                    const selectedFunction = this.value;
                    Office.context.ui.messageParent(JSON.stringify({
                        action: 'getFunctionCode',
                        name: selectedFunction
                    }));
                };

                document.getElementById('saveBtn').onclick = function () {
                    const messageData = {
                        code: editor.getValue(),
                        testCases: testEditor.getValue()
                    };
                    Office.context.ui.messageParent(JSON.stringify(messageData));
                    // Disable the button both in JS and HTML
                    this.disabled = true;
                    this.setAttribute('disabled', 'disabled');
                };

                document.getElementById('cancelBtn').onclick = function () {
                    Office.context.ui.messageParent('');
                };
            });
        });
    </script>
</body>

</html>